SELECT
T1.PARTITION_KEY,
'FACILITY' AS TABLE_NAME,
T1.CONTRACT_REFERENCE AS REFERENCE,
T3.AGENCY_CODE,
T3.RATING_CODE,
NULL AS RATING_DATE,
T1.ATTRIBUTE_1,
T1.CONTRACT_REFERENCE AS ATTRIBUTE_2,
'SPIN'||T1.IMPORT_SOURCE AS IMPORT_SOURCE,
T3.SHORT_TERM_RATING,
NULL AS RATING_APPROACH
FROM FACILITY T1
OUTER APPLY (
SELECT * FROM TBIS_SECURITIZATION_LIST T2
WHERE (T1.COUNTERPARTY_CODE=T2.CUST_CODE AND T1.CONTRACT_REFERENCE=T2.CONTRACT_REFERENCE AND
SUBSTR(T1.IMPORT_SOURCE, 5, 3)=T2.IMPORT_SOURCE AND (T2.ACTIVE IN ('N', 'Y') OR T2.ACTIVE IS NULL)) OR
(T1.COUNTERPARTY_CODE=T2.CUST_CODE AND T1.CONTRACT_REFERENCE IS NOT NULL AND T1.IMPORT_SOURCE IS NOT NULL AND
T2.CONTRACT_REFERENCE IS NULL AND T2.IMPORT_SOURCE IS NULL AND (T2.ACTIVE='Y' OR T2.ACTIVE IS NULL))
ORDER BY T2.ACTIVE,
    CASE WHEN (T2.CONTRACT_REFERENCE IS NULL AND T2.IMPORT_SOURCE IS NULL) THEN 1 ELSE 0 END
FETCH FIRST 1 ROWS ONLY
) T2
CROSS APPLY (
SELECT 'INFERRED' AS AGENCY_CODE, LT_INFERRED_RATING_NONGMP AS RATING_CODE, ST_INFERRED_RATING_NONGMP AS SHORT_TERM_RATING FROM DUAL UNION ALL
SELECT 'FITCHINV',
CASE WHEN LT_INFERRED_RATING_NONGMP IS NOT NULL OR ST_INFERRED_RATING_NONGMP IS NOT NULL THEN NULL ELSE LT_FITCH_RATING_NONGMP END,
CASE WHEN LT_INFERRED_RATING_NONGMP IS NOT NULL OR ST_INFERRED_RATING_NONGMP IS NOT NULL THEN NULL ELSE ST_FITCH_RATING_NONGMP END
FROM DUAL UNION ALL
SELECT 'MOODYS',
CASE WHEN LT_INFERRED_RATING_NONGMP IS NOT NULL OR ST_INFERRED_RATING_NONGMP IS NOT NULL THEN NULL ELSE LT_MOODYS_RATING_NONGMP END,
CASE WHEN LT_INFERRED_RATING_NONGMP IS NOT NULL OR ST_INFERRED_RATING_NONGMP IS NOT NULL THEN NULL ELSE ST_MOODYS_RATING_NONGMP END
FROM DUAL UNION ALL
SELECT 'STD_POORS',
CASE WHEN LT_INFERRED_RATING_NONGMP IS NOT NULL OR ST_INFERRED_RATING_NONGMP IS NOT NULL THEN NULL ELSE LT_STDPOORS_RATING_NONGMP END,
CASE WHEN LT_INFERRED_RATING_NONGMP IS NOT NULL OR ST_INFERRED_RATING_NONGMP IS NOT NULL THEN NULL ELSE ST_STDPOORS_RATING_NONGMP END
FROM DUAL
) T3
WHERE T1.IMPORT_SOURCE LIKE '%LES%' AND T1.PARTITION_KEY='202312310000' AND
T2.CUST_CODE IS NOT NULL AND (T2.ACTIVE='Y' OR T2.ACTIVE IS NULL) AND
(T3.RATING_CODE IS NOT NULL OR T3.SHORT_TERM_RATING IS NOT NULL)
ORDER BY REFERENCE
;
